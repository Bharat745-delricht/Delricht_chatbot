<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DelRicht Research - Clinical Trials</title>
    <style>
        /* Global Styles */
        body {
            font-family: 'Poppins', Arial, sans-serif !important;
            background-color: #f8f9fa !important;
            margin: 0 !important;
            color: #333 !important;
            line-height: 1.4 !important;
        }

        /* Header - Match container width */
        .header {
            text-align: center !important;
            font-size: 24px !important;
            font-weight: 700 !important;
            color: white !important;
            background: #00265e !important;
            padding: 18px !important;
            border-radius: 12px !important;
            max-width: calc(1200px - 36px) !important;
            margin: 0 auto 8px auto !important;
        }

        /* Container Layout */
        .container {
            display: flex !important;
            max-width: 1200px !important;
            margin: 8px auto !important;
            padding: 0 18px !important;
            gap: 25px !important;
        }

        /* Left Section */
        .left-section {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
        }

        /* Card/Bubble Styling */
        .info-card, .benefits-section, .next-steps-card {
            background: white !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            padding: 16px 18px !important;
        }

        .info-card h2, .benefits-section h2, .next-steps-card h2 {
            color: #00265e !important;
            font-size: 20px !important;
            font-weight: 700 !important;
            margin: 0 0 10px 0 !important;
            padding: 0 !important;
        }

        .info-card p {
            font-size: 15px !important;
            color: #555 !important;
            margin: 0 !important;
            line-height: 1.5 !important;
        }

        /* Benefits Grid */
        .benefits-grid {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 14px !important;
        }

        .benefit-card {
            display: flex !important;
            align-items: flex-start !important;
            gap: 10px !important;
        }

        .icon-element {
            flex-shrink: 0 !important;
        }

        .icon-element img {
            width: 28px !important;
            height: 28px !important;
            object-fit: contain !important;
        }

        .benefit-content {
            flex: 1 !important;
        }

        .benefit-title {
            color: #00265e !important;
            font-weight: 700 !important;
            font-size: 15px !important;
            margin: 0 0 4px 0 !important;
        }

        .benefit-text {
            color: #555 !important;
            font-size: 13px !important;
            margin: 0 !important;
            line-height: 1.4 !important;
        }

        /* Next Steps Section */
        .next-steps-list {
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
            margin: 0 !important;
            padding: 0 !important;
            list-style: none !important;
        }

        .next-step-item {
            display: flex !important;
            align-items: flex-start !important;
            gap: 10px !important;
            padding: 8px 10px !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
            border-left: 3px solid #00999D !important;
        }

        .step-number {
            width: 22px !important;
            height: 22px !important;
            background: #00265e !important;
            color: white !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 700 !important;
            font-size: 11px !important;
            flex-shrink: 0 !important;
        }

        .step-text {
            flex: 1 !important;
            font-size: 13px !important;
            color: #333 !important;
            line-height: 1.3 !important;
        }

        /* Chatbot Section */
        .chatbot-section {
            flex: 1 !important;
            max-width: 450px !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* Chat Header */
        #chat-header-container {
            background: white !important;
            border-radius: 12px 12px 0 0 !important;
            padding: 12px 16px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
        }

        .chat-avatar-container {
            width: 46px !important;
            height: 46px !important;
            background: white !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            position: relative !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
            overflow: visible !important;
        }

        .chat-robot-img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }

        .chat-avatar-online {
            position: absolute !important;
            bottom: -2px !important;
            right: -2px !important;
            width: 14px !important;
            height: 14px !important;
            background-color: #00ff88 !important;
            border: 2px solid white !important;
            border-radius: 50% !important;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.6) !important;
            animation: pulse 2s infinite !important;
            z-index: 10 !important;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.15); }
        }

        .chat-header-text {
            flex: 1 !important;
        }

        .chat-header-title {
            font-size: 16px !important;
            font-weight: 600 !important;
            color: #00265e !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
        }

        .beta-tag-blue {
            font-style: italic !important;
            font-weight: 700 !important;
            font-size: 10px !important;
            color: #00265e !important;
            opacity: 0.8 !important;
            text-transform: uppercase !important;
        }

        .chat-header-subtitle {
            font-size: 12px !important;
            color: #666 !important;
            margin: 2px 0 0 0 !important;
        }

        #chat-container {
            width: 100% !important;
            height: 550px !important;
            background: white !important;
            border-radius: 0 0 12px 12px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
        }

        #chat-box {
            flex: 1 !important;
            padding: 12px !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 8px !important;
            background: #f8f9fa !important;
        }

        .message {
            padding: 10px 12px !important;
            border-radius: 20px !important;
            max-width: 75% !important;
            font-size: 14px !important;
            word-wrap: break-word !important;
            white-space: pre-wrap !important;
            box-sizing: border-box !important;
            line-height: 1.5 !important;
        }

        .message.user {
            background-color: #00265e !important;
            color: white !important;
            margin-left: auto !important;
            margin-right: 0 !important;
            text-align: right !important;
        }

        .message.bot {
            background-color: white !important;
            color: #333 !important;
            margin-right: auto !important;
            margin-left: 0 !important;
            text-align: left !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }

        /* Feedback buttons */
        .message-feedback {
            display: flex !important;
            gap: 8px !important;
            margin-top: 6px !important;
            opacity: 0.6 !important;
            transition: opacity 0.2s !important;
        }

        .message-feedback:hover {
            opacity: 1.0 !important;
        }

        .feedback-btn {
            background: none !important;
            border: none !important;
            font-size: 16px !important;
            cursor: pointer !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            transition: all 0.2s !important;
            opacity: 0.5 !important;
        }

        .feedback-btn:hover {
            opacity: 1.0 !important;
            background: #f0f0f0 !important;
        }

        .feedback-btn:disabled {
            cursor: default !important;
            opacity: 0.3 !important;
        }

        .feedback-btn.selected {
            opacity: 1.0 !important;
            transform: scale(1.2) !important;
        }

        /* Quick Reply Buttons Container */
        .quick-replies {
            display: flex !important;
            flex-direction: row !important;
            gap: 12px !important;
            margin: 12px 0 !important;
            max-width: 100% !important;
            flex-wrap: wrap !important;
            padding: 0 !important;
        }

        .quick-reply-btn {
            padding: 14px 18px !important;
            background: white !important;
            border: 2px solid #00265e !important;
            color: #00265e !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
            text-align: center !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
            flex: 1 !important;
            min-width: 150px !important;
            white-space: pre-line !important;
            line-height: 1.4 !important;
            font-family: 'Poppins', Arial, sans-serif !important;
            margin: 0 !important;
        }

        .quick-reply-btn:hover {
            background: #00265e !important;
            color: white !important;
            transform: translateX(4px) !important;
        }

        .quick-reply-btn:active {
            transform: scale(0.98) !important;
        }

        /* Typing Indicator */
        .typing-indicator {
            background-color: white !important;
            color: black !important;
            margin-right: auto !important;
            margin-left: 0 !important;
            text-align: left !important;
            padding: 14px 18px !important;
            border-radius: 20px !important;
            max-width: 80px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 6px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        .typing-dot {
            width: 8px !important;
            height: 8px !important;
            background-color: #00265e !important;
            border-radius: 50% !important;
            animation-name: typing-bounce-pause !important;
            animation-duration: 2.2s !important;
            animation-timing-function: ease-in-out !important;
            animation-iteration-count: infinite !important;
            animation-fill-mode: both !important;
        }

        #typing-indicator .typing-dot:nth-child(1) {
            animation-delay: 0s !important;
        }
        #typing-indicator .typing-dot:nth-child(2) {
            animation-delay: 0.15s !important;
        }
        #typing-indicator .typing-dot:nth-child(3) {
            animation-delay: 0.3s !important;
        }

        @keyframes typing-bounce-pause {
            0% {
                transform: translateY(0px);
                opacity: 0.3;
            }
            27% {
                transform: translateY(-10px);
                opacity: 1;
            }
            54% {
                transform: translateY(0px);
                opacity: 0.3;
            }
            100% {
                transform: translateY(0px);
                opacity: 0.3;
            }
        }

        #input-container {
            display: flex !important;
            padding: 12px !important;
            background: #fff !important;
            border-top: 1px solid #ddd !important;
            align-items: center !important;
            gap: 8px !important;
        }

        #user-input {
            flex: 1 !important;
            padding: 12px !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-family: 'Poppins', Arial, sans-serif !important;
        }

        #send-button {
            background: #00265e !important;
            color: white !important;
            border: none !important;
            padding: 12px 18px !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            transition: background 0.3s !important;
        }

        #send-button:hover:not(:disabled) {
            background: #001b45 !important;
        }

        #send-button:disabled {
            background: #999 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        /* Scrollbar Styling */
        #chat-box::-webkit-scrollbar {
            width: 6px !important;
        }

        #chat-box::-webkit-scrollbar-track {
            background: #f1f1f1 !important;
        }

        #chat-box::-webkit-scrollbar-thumb {
            background: #888 !important;
            border-radius: 3px !important;
        }

        #chat-box::-webkit-scrollbar-thumb:hover {
            background: #555 !important;
        }

        /* Responsive Design */
        @media (max-width: 940px) {
            .container {
                flex-direction: column !important;
                align-items: center !important;
            }

            .left-section, .chatbot-section {
                width: 100% !important;
                max-width: 600px !important;
            }

            .benefits-grid {
                grid-template-columns: 1fr !important;
            }

            .quick-replies {
                flex-direction: column !important;
            }

            .quick-reply-btn {
                width: 100% !important;
                min-width: unset !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">WE'RE EXCITED TO SEE YOU AT THE CLINIC!</div>
    <div class="container">
        <!-- Left Section: Info Cards -->
        <div class="left-section">
            <!-- What to Expect Next -->
            <div class="next-steps-card">
                <h2>What to Expect Next</h2>
                <ul class="next-steps-list">
                    <li class="next-step-item">
                        <div class="step-number">1</div>
                        <div class="step-text">Text from our number to introduce ourselves</div>
                    </li>
                    <li class="next-step-item">
                        <div class="step-number">2</div>
                        <div class="step-text">A phone call to discuss the study & schedule an appointment</div>
                    </li>
                    <li class="next-step-item">
                        <div class="step-number">3</div>
                        <div class="step-text">Visit to the clinic with one of our coordinators</div>
                    </li>
                </ul>
            </div>

            <!-- Benefits Section -->
            <div class="benefits-section">
                <h2>Benefits of Participation</h2>
                <div class="benefits-grid">
                    <div class="benefit-card">
                        <div class="icon-element">
                            <img src="https://delrichtresearch.com/wp-content/uploads/2023/10/electric-car.png" alt="Help Move Medicine Forward">
                        </div>
                        <div class="benefit-content">
                            <div class="benefit-title">Help Move Medicine Forward</div>
                            <div class="benefit-text">Be a key player in medical breakthroughs by participating in our clinical trials.</div>
                        </div>
                    </div>

                    <div class="benefit-card">
                        <div class="icon-element">
                            <img src="https://delrichtresearch.com/wp-content/uploads/2023/09/insurance-1-1.png" alt="Compensation for Time and Travel">
                        </div>
                        <div class="benefit-content">
                            <div class="benefit-title">Compensation for Time and Travel</div>
                            <div class="benefit-text">We acknowledge your effort with fair compensation for your participation time and travel expenses.</div>
                        </div>
                    </div>

                    <div class="benefit-card">
                        <div class="icon-element">
                            <img src="https://delrichtresearch.com/wp-content/uploads/2023/09/access-1.png" alt="Free Medical Assessments">
                        </div>
                        <div class="benefit-content">
                            <div class="benefit-title">Free Medical Assessments</div>
                            <div class="benefit-text">Experience top-notch medical care and health assessments at no personal expense.</div>
                        </div>
                    </div>

                    <div class="benefit-card">
                        <div class="icon-element">
                            <img src="https://delrichtresearch.com/wp-content/uploads/2023/10/pills.png" alt="Access to New Treatments">
                        </div>
                        <div class="benefit-content">
                            <div class="benefit-title">Access to New Treatments</div>
                            <div class="benefit-text">Explore tomorrow's treatments today by accessing potential breakthrough therapies before they become widely available.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Section: Chatbot -->
        <div class="chatbot-section">
            <!-- Chat Header with Avatar -->
            <div id="chat-header-container">
                <div class="chat-avatar-container">
                    <img src="https://delrichtresearch.com/wp-content/uploads/2026/01/graident-ai-robot-vectorart_78370-4114.avif" alt="Eric" class="chat-robot-img" />
                    <div class="chat-avatar-online"></div>
                </div>

                <div class="chat-header-text">
                    <div class="chat-header-title">
                        Recruitment Coordinator
                        <span class="beta-tag-blue">BETA</span>
                    </div>
                    <div class="chat-header-subtitle">Hi, I'm Eric!</div>
                </div>
            </div>

            <!-- Chat Container -->
            <div id="chat-container">
                <div id="chat-box"></div>
                <div id="input-container">
                    <input type="text" id="user-input" placeholder="Type a message..." autofocus />
                    <button id="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // Wait for DOM to be fully ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initChatbot);
        } else {
            initChatbot();
        }

        function initChatbot() {
            console.log('Initializing chatbot...');

            const chatBox = document.getElementById("chat-box");
            const userInput = document.getElementById("user-input");
            const sendButton = document.getElementById("send-button");

            if (!chatBox || !userInput || !sendButton) {
                console.error('Chatbot elements not found!', {chatBox, userInput, sendButton});
                return;
            }

            console.log('Chatbot elements found successfully');

            // Get or create persistent user ID and session ID
            let userID = localStorage.getItem("delricht_user_id");
            if (!userID) {
                userID = "user_" + Math.random().toString(36).substr(2, 9);
                localStorage.setItem("delricht_user_id", userID);
            }

            let sessionID = sessionStorage.getItem("delricht_session_id");
            if (!sessionID) {
                sessionID = "session_" + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem("delricht_session_id", sessionID);
            }

            console.log("Session ID:", sessionID, "User ID:", userID);

            // Utility Functions
            function scrollToBottom() {
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function formatMessage(text) {
                if (!text) return "";

                // FIXED: Properly escaped regex patterns
                // Bold text with **text**
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Italic text with *text*
                text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                // Line breaks
                text = text.replace(/\n/g, '<br>');

                return text;
            }

            function addUserMessage(content) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", "user");
                messageDiv.textContent = content;
                chatBox.appendChild(messageDiv);
                scrollToBottom();
            }

            function addBotMessage(content, quickReplies, messageId) {
                if (!content || content === "undefined") {
                    content = "I apologize, but I'm having trouble connecting. Please try again or contact us at (504) 336-2667.";
                }

                const messageWrapper = document.createElement("div");
                messageWrapper.classList.add("message", "bot");

                const contentDiv = document.createElement("div");
                contentDiv.classList.add("message-content");
                contentDiv.innerHTML = formatMessage(content);
                messageWrapper.appendChild(contentDiv);

                // Add feedback buttons if we have a message ID
                if (messageId) {
                    const feedbackDiv = document.createElement("div");
                    feedbackDiv.classList.add("message-feedback");
                    feedbackDiv.innerHTML = `
                        <button class="feedback-btn" data-message-id="${messageId}" data-rating="positive" title="This was helpful">üëç</button>
                        <button class="feedback-btn" data-message-id="${messageId}" data-rating="negative" title="This wasn't helpful">üëé</button>
                    `;
                    messageWrapper.appendChild(feedbackDiv);

                    // Add click handlers
                    setTimeout(function() {
                        feedbackDiv.querySelectorAll('.feedback-btn').forEach(function(btn) {
                            btn.addEventListener('click', function() {
                                submitFeedback(this.dataset.messageId, this.dataset.rating, this);
                            });
                        });
                    }, 0);
                }

                chatBox.appendChild(messageWrapper);

                if (quickReplies && quickReplies.length > 0) {
                    addQuickReplies(quickReplies);
                }

                scrollToBottom();
            }

            function addQuickReplies(replies) {
                const quickRepliesDiv = document.createElement("div");
                quickRepliesDiv.classList.add("quick-replies");

                replies.forEach(function(reply) {
                    const btn = document.createElement("button");
                    btn.classList.add("quick-reply-btn");
                    btn.textContent = reply.label || reply;
                    btn.onclick = function() {
                        quickRepliesDiv.remove();
                        const valueToSend = reply.value || reply.label || reply;
                        userInput.value = valueToSend;
                        sendMessage();
                    };
                    quickRepliesDiv.appendChild(btn);
                });

                chatBox.appendChild(quickRepliesDiv);
                scrollToBottom();
            }

            function showTypingIndicator() {
                const typingDiv = document.createElement("div");
                typingDiv.classList.add("typing-indicator");
                typingDiv.id = "typing-indicator";

                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement("div");
                    dot.classList.add("typing-dot");
                    typingDiv.appendChild(dot);
                }

                chatBox.appendChild(typingDiv);
                scrollToBottom();
            }

            function hideTypingIndicator() {
                const typingIndicator = document.getElementById("typing-indicator");
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            function submitFeedback(messageId, rating, buttonElement) {
                console.log(`Submitting ${rating} feedback for message ${messageId}`);

                fetch("https://gemini-chatbot-dev-5xnn5dcwlq-uc.a.run.app/api/gemini/feedback", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        session_id: sessionID,
                        message_id: parseInt(messageId),
                        feedback_type: rating
                    })
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    console.log('Feedback recorded:', data);
                    // Disable both buttons after feedback
                    const feedbackDiv = buttonElement.parentElement;
                    feedbackDiv.querySelectorAll('.feedback-btn').forEach(function(btn) {
                        btn.disabled = true;
                    });
                    // Highlight selected button
                    buttonElement.classList.add('selected');
                })
                .catch(function(error) {
                    console.error('Feedback error:', error);
                });
            }

            function sendMessage() {
                const message = userInput.value.trim();
                if (message === "") return;

                console.log('Sending message:', message);

                userInput.disabled = true;
                sendButton.disabled = true;

                addUserMessage(message);
                userInput.value = "";

                showTypingIndicator();

                fetch("https://gemini-chatbot-dev-5xnn5dcwlq-uc.a.run.app/api/gemini/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionID,
                        user_id: userID
                    }),
                })
                .then(function(response) {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(function(data) {
                    hideTypingIndicator();

                    const botResponse = data.response || data.message || "I'm sorry, I couldn't process your request.";
                    const quickReplies = data.quick_replies || null;
                    const messageId = data.metadata && data.metadata.message_id;

                    console.log('Received response:', {botResponse, quickReplies, messageId});

                    addBotMessage(botResponse, quickReplies, messageId);

                    if (data.metadata) console.log("Metadata:", data.metadata);
                    if (data.intent) console.log("Intent:", data.intent);
                })
                .catch(function(error) {
                    console.error('Chat error:', error);
                    hideTypingIndicator();
                    addBotMessage("I apologize, but I'm having trouble connecting. Please try again or contact us at (504) 336-2667.");
                })
                .finally(function() {
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    userInput.focus();
                });
            }

            // Event listeners
            sendButton.addEventListener("click", sendMessage);
            userInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    if (userInput.value.trim() !== "") sendMessage();
                }
            });

            // Initial warm welcome message (no feedback buttons on welcome)
            console.log('Adding initial welcome message...');
            addBotMessage("Hey! I'm Eric. I help people find clinical trials that might be a good match for them. What brings you here today?", null, null);
            console.log('Chatbot initialization complete!');
        }
    })();
    </script>
</body>
</html>
