<style>
/* Embedded Chatbot Styles - ALL FORCED */

#chat-header {
    font-size: 18px !important;
    font-weight: 600 !important;
    color: #00265e !important;
    margin-bottom: 8px !important;
    text-align: center !important;
    font-family: 'Poppins', Arial, sans-serif !important;
    padding: 0 !important;
}

#chat-container {
    width: 100% !important;
    height: 550px !important;
    background: white !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
}

#chat-box {
    flex: 1 !important;
    padding: 12px !important;
    overflow-y: auto !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    background: #f8f9fa !important;
}

.message {
    padding: 10px 12px !important;
    border-radius: 20px !important;
    max-width: 75% !important;
    font-size: 14px !important;
    word-wrap: break-word !important;
    white-space: pre-wrap !important;
    box-sizing: border-box !important;
    line-height: 1.5 !important;
}

.message.user {
    background-color: #00265e !important;
    color: white !important;
    margin-left: auto !important;
    margin-right: 0 !important;
    text-align: right !important;
}

.message.bot {
    background-color: #f1f1f1 !important;
    color: black !important;
    margin-right: auto !important;
    margin-left: 0 !important;
    text-align: left !important;
}

/* Quick Reply Buttons Container - HORIZONTAL LAYOUT */
.quick-replies {
    display: flex !important;
    flex-direction: row !important;  /* Horizontal layout */
    gap: 12px !important;
    margin: 12px 0 !important;
    max-width: 100% !important;  /* Full width */
    flex-wrap: wrap !important;  /* Wrap on smaller screens */
    padding: 0 !important;
}

/* Quick Reply Buttons - TWO-LINE FORMAT */
.quick-reply-btn {
    padding: 14px 18px !important;
    background: white !important;
    border: 2px solid #00265e !important;
    color: #00265e !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s !important;
    text-align: center !important;  /* Center text */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    flex: 1 !important;  /* Equal width buttons */
    min-width: 150px !important;  /* Minimum readable width */
    white-space: pre-line !important;  /* CRITICAL: Allows \n line breaks */
    line-height: 1.4 !important;  /* Better spacing between lines */
    font-family: 'Poppins', Arial, sans-serif !important;
    margin: 0 !important;
}

.quick-reply-btn:hover {
    background: #00265e !important;
    color: white !important;
    transform: translateX(4px) !important;
}

.quick-reply-btn:active {
    transform: scale(0.98) !important;
}

/* Typing Indicator */
.typing-indicator {
    background-color: #f1f1f1 !important;
    color: black !important;
    margin-right: auto !important;
    margin-left: 0 !important;
    padding: 10px 12px !important;
    border-radius: 20px !important;
    max-width: 75px !important;
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
}

.typing-dot {
    width: 6px !important;
    height: 6px !important;
    background-color: #999 !important;
    border-radius: 50% !important;
    animation: typing 1.4s infinite !important;
}

.typing-dot:nth-child(1) { animation-delay: 0s !important; }
.typing-dot:nth-child(2) { animation-delay: 0.2s !important; }
.typing-dot:nth-child(3) { animation-delay: 0.4s !important; }

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0) !important;
        opacity: 0.4 !important;
    }
    30% {
        transform: translateY(-8px) !important;
        opacity: 1 !important;
    }
}

#input-container {
    display: flex !important;
    padding: 10px !important;
    background: #fff !important;
    border-top: 1px solid #ddd !important;
    align-items: center !important;
    gap: 6px !important;
}

#user-input {
    flex: 1 !important;
    padding: 10px !important;
    border: 1px solid #ddd !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    font-family: 'Poppins', Arial, sans-serif !important;
}

#send-button {
    background: #00265e !important;
    color: white !important;
    border: none !important;
    padding: 10px 15px !important;
    border-radius: 8px !important;
    cursor: pointer !important;
    font-size: 14px !important;
    transition: background 0.3s !important;
    font-family: 'Poppins', Arial, sans-serif !important;
    font-weight: 600 !important;
}

#send-button:hover:not(:disabled) {
    background: #001b45 !important;
}

#send-button:disabled {
    background: #999 !important;
    cursor: not-allowed !important;
    opacity: 0.6 !important;
}

/* Scrollbar Styling */
#chat-box::-webkit-scrollbar {
    width: 6px !important;
}

#chat-box::-webkit-scrollbar-track {
    background: #f1f1f1 !important;
}

#chat-box::-webkit-scrollbar-thumb {
    background: #888 !important;
    border-radius: 3px !important;
}

#chat-box::-webkit-scrollbar-thumb:hover {
    background: #555 !important;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    #chat-container {
        height: 500px !important;
    }

    /* Stack buttons vertically on mobile */
    .quick-replies {
        flex-direction: column !important;
        gap: 8px !important;
    }

    .quick-reply-btn {
        width: 100% !important;
        min-width: unset !important;
    }
}
</style>

<!-- Chat Interface HTML -->
<div id="chat-header">Chat with Eric <span style="font-style: italic; font-weight: 700; font-size: 12px; color: #00999D; margin-left: 6px;">BETA</span></div>
<div id="chat-container">
    <div id="chat-box"></div>
    <div id="input-container">
        <input type="text" id="user-input" placeholder="Type your message...">
        <button id="send-button">Send</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");

    let userID = "user_" + Math.random().toString(36).substr(2, 9);
    let sessionID = "session_" + Math.random().toString(36).substr(2, 9);

    // Utility Functions
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function formatMessage(text) {
        if (!text) return "";
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
        text = text.replace(/\n/g, '<br>');
        return text;
    }

    function addUserMessage(content) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", "user");
        messageDiv.textContent = content;
        chatBox.appendChild(messageDiv);
        scrollToBottom();
    }

    function addBotMessage(content, quickReplies = null) {
        if (!content || content === "undefined") {
            content = "I apologize, but I'm having trouble connecting to our research database. Please try again or contact us directly at (504) 336-2667.";
        }

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", "bot");
        messageDiv.innerHTML = formatMessage(content);
        chatBox.appendChild(messageDiv);

        // Add quick reply buttons if provided
        if (quickReplies && quickReplies.length > 0) {
            addQuickReplies(quickReplies);
        }

        scrollToBottom();
    }

    function addQuickReplies(replies) {
        const quickRepliesDiv = document.createElement("div");
        quickRepliesDiv.classList.add("quick-replies");

        replies.forEach(reply => {
            const btn = document.createElement("button");
            btn.classList.add("quick-reply-btn");
            btn.textContent = reply.label || reply;
            btn.onclick = () => {
                quickRepliesDiv.remove();
                const valueToSend = reply.value || reply.label || reply;
                userInput.value = valueToSend;
                sendMessage();
            };
            quickRepliesDiv.appendChild(btn);
        });

        chatBox.appendChild(quickRepliesDiv);
        scrollToBottom();
    }

    function showTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.classList.add("typing-indicator");
        typingDiv.id = "typing-indicator";

        for (let i = 0; i < 3; i++) {
            const dot = document.createElement("div");
            dot.classList.add("typing-dot");
            typingDiv.appendChild(dot);
        }

        chatBox.appendChild(typingDiv);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById("typing-indicator");
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    function sendMessage() {
        const message = userInput.value.trim();
        if (message === "") return;

        userInput.disabled = true;
        sendButton.disabled = true;

        addUserMessage(message);
        userInput.value = "";

        showTypingIndicator();

        fetch("https://gemini-chatbot-480267397633.us-central1.run.app/api/gemini/chat", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                message: message,
                session_id: sessionID,
                user_id: userID
            }),
        })
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
        })
        .then(data => {
            hideTypingIndicator();

            const botResponse = data.response || data.message || "I'm sorry, I couldn't process your request.";
            const quickReplies = data.quick_replies || null;

            addBotMessage(botResponse, quickReplies);

            // Debug logging
            if (data.metadata) console.log("Metadata:", data.metadata);
            if (data.intent) console.log("Intent:", data.intent);
            if (quickReplies) console.log("Quick Replies:", quickReplies);
        })
        .catch(error => {
            hideTypingIndicator();
            addBotMessage("I apologize, but I'm having trouble connecting to our research database. Please try again or contact us directly at (504) 336-2667.");
            console.error("Error:", error);
        })
        .finally(() => {
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        });
    }

    // Event Listeners
    sendButton.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            if (userInput.value.trim() !== "") sendMessage();
        }
    });

    // Initial welcome message
    addBotMessage("Hey! I'm Eric. I help people find clinical trials that might be a good match for them. What brings you here today?");
});
</script>
